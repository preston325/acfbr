Part 1 — Local Docker → ECR

1) Confirm Image Exists
docker images | grep acfbr-app

2) Set Variables
AWS_REGION=us-west-2
AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
ECR_REPO=acfbr
IMAGE_TAG=latest

3) Make sure ECR_REPO=acfbr exists in AWS ECR Management Console

4)Login Docker to ECR
aws ecr get-login-password --region $AWS_REGION \
| docker login --username AWS --password-stdin \
${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

5) Important on Mac (Apple Silicon): build for linux/amd64
docker buildx create --use --name acfbr_builder 2>/dev/null || docker buildx use acfbr_builder

docker buildx build \
  --platform linux/amd64 \
  -t ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/${ECR_REPO}:${IMAGE_TAG} \
  --push .

Part 2 — Run the container in ECS (Fargate + ALB)

6. Create an ECS cluster (console)
AWS Console → ECS → Clusters → Create cluster
Name: acfbr-cluster
Infrastructure: Fargate
Create

7. Create a Task Definition (console)
ECS → Task definitions → Create new
Launch type: Fargate
OS: Linux
CPU/Memory: start with 0.25 vCPU / 0.5–1 GB
Container settings
Name: acfbr
Image: <ACCOUNT_ID>.dkr.ecr.<region>.amazonaws.com/acfbr:latest
Port mapping: 3000

Env vars: add your DB vars (you can use EITHER method):

Method 1: Use DATABASE_URL (recommended - single variable)
DATABASE_URL=postgresql://postgres:Snoqualmie2015%21@tdpllc-1.cqgd5zbaiuii.us-west-2.rds.amazonaws.com:5432/acfbr?sslmode=require

Method 2: Use individual variables (alternative)
DB_HOST=tdpllc-1.cqgd5zbaiuii.us-west-2.rds.amazonaws.com
DB_PORT=5432
DB_NAME=acfbr
DB_USER=postgres
DB_PASSWORD=Snoqualmie2015!

Also add other required env vars:
JWT_SECRET=your-secret-key-change-in-production
SPORTSDB_API_KEY=428457
NODE_ENV=production
SMTP_HOST=smtp-relay.brevo.com
SMTP_PORT=587
SMTP_USER=a046c2001@smtp-brevo.com
SMTP_PASSWORD=Etc4dfDOsMUyvISA
SMTP_FROM=americas.cfb.rankings@gmail.com
APP_URL=https://your-domain.com (or your ALB DNS name)

Logging (do this)
awslogs, log group /ecs/acfbr, stream prefix ecs

Save task definition.

8. Create the Load Balancer + ECS Service (console)
ECS → Clusters → acfbr-cluster → Create service

Launch type: Fargate

Task definition: acfbr:latest

Service name: acfbr-service

Desired tasks: 1

Networking

Choose the VPC you want (ideally same VPC as RDS)

Choose 2+ subnets

Create/choose Security Groups:

Security Group A (ALB SG): acfbr-alb-sg

Inbound:

80 from 0.0.0.0/0

443 from 0.0.0.0/0 (we’ll enable once cert exists)

Outbound: allow all

Security Group B (ECS Task SG): acfbr-task-sg

Inbound:

TCP 3000 from acfbr-alb-sg (source = SG, not CIDR)

Outbound: allow all (so it can reach RDS)

Load Balancing

Enable Load Balancer

Type: Application Load Balancer

Create new ALB:

Name: acfbr-alb

Internet-facing

Listener: HTTP :80 (for now)

Target group:

Target type: IP

Port: 3000

Health check path: / (or your real health endpoint like /health)

Create service.

Part 3 — Critical: RDS Security Group Configuration

IMPORTANT: For ECS to connect to RDS, you MUST configure the RDS security group:

1. Go to RDS → Databases → tdpllc-1 → Connectivity & security → VPC security groups
2. Click on the security group
3. Edit inbound rules
4. Add rule:
   - Type: PostgreSQL (or Custom TCP)
   - Port: 5432
   - Source: acfbr-task-sg (select the ECS task security group, NOT a CIDR block)
   - Description: Allow ECS tasks to connect to RDS
5. Save rules

Troubleshooting ECS Database Connection Issues:

1. Check ECS Task Logs:
   - CloudWatch → Log groups → /ecs/acfbr
   - Look for database connection errors

2. Verify Security Groups:
   - ECS Task SG (acfbr-task-sg): Outbound rules should allow all traffic (0.0.0.0/0)
   - RDS Security Group: Inbound rule should allow port 5432 from ECS Task SG

3. Verify VPC/Subnet:
   - ECS tasks and RDS should be in the same VPC
   - ECS tasks need internet access (via NAT Gateway) OR direct VPC connectivity to RDS

4. Test Connection from ECS Task:
   - You can exec into the running task and test the connection
   - Or check the application logs for specific error messages

5. Common Errors:
   - "Connection timeout" → Security group or network routing issue
   - "no pg_hba.conf entry" → Security group not allowing connection
   - "SSL required" → Already handled in code, but verify SSL config
   - "password authentication failed" → Check DB_PASSWORD value